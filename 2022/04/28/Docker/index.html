<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Golang Docker · Notebook</title><meta name="description" content="Golang Docker - Simon Ren"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Notebook"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Notebook" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Golang Docker</h1><div class="post-info">Apr 28, 2022</div><div class="post-content"><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Docker Desktop: <a target="_blank" rel="noopener" href="https://www.docker.com/products/docker-desktop/">https://www.docker.com/products/docker-desktop/</a><br>Docker Hub: <a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></p>
<h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a><code>docker</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker image</span></span><br><span class="line">docker pull postgres</span><br><span class="line">docker image ls</span><br><span class="line">docker image rm image-name # remove image-name</span><br><span class="line">docker rmi image-name # remove image-name</span><br><span class="line">docker image inspect image-name</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> start container</span></span><br><span class="line">docker run --name mypgsql -p 5432:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=password -e POSTGRES_HOST_AUTH_METHOD=password -d postgres</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> maintain</span></span><br><span class="line">docker ps</span><br><span class="line">docker stats CONTAINER</span><br><span class="line">docker logs -f CONTAINER</span><br><span class="line">dokcer exec -it CONTAINER /bin/sh</span><br><span class="line">docker top CONTAINER</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker system</span></span><br><span class="line">docker system df</span><br><span class="line">docker builder prune # clean build cache</span><br><span class="line">docker container prune # clean unused container</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> build image</span></span><br><span class="line">docker build -t tagname -f path/to/Dockerfile .</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> registry</span></span><br><span class="line">docker login</span><br><span class="line">docker login registry.gitlab.com</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> network</span></span><br><span class="line">docker network create -d bridge test-net</span><br><span class="line">docker run -itd --name test1 --network test-net ubuntu /bin/bash</span><br><span class="line">docker run -itd --name test2 --network test-net ubuntu /bin/bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> save</span></span><br><span class="line">docker save busybox &gt; busybox.tar</span><br><span class="line">docker save -o fedora-latest.tar fedora:latest</span><br><span class="line">docker save myimage:latest | gzip &gt; myimage_latest.tar.gz</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">export</span></span></span><br><span class="line">docker export 1e560fca3906 &gt; ubuntu.tar</span><br><span class="line">cat docker/ubuntu.tar | docker import - test/ubuntu:v1</span><br></pre></td></tr></table></figure>

<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this is builder</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.18</span>.<span class="number">0</span>-buster as builder</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y --no-install-recommends build-essential \</span></span><br><span class="line"><span class="bash">	&amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /sources</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /sources &amp;&amp; make build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> debian:buster-slim</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y --no-install-recommends \</span></span><br><span class="line"><span class="bash">	ca-certificates libaio1 \</span></span><br><span class="line"><span class="bash">	&amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /sources/bin /usr/<span class="built_in">local</span>/bin</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /sources/resources /usr/<span class="built_in">local</span>/resources</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> SOME_ENV=<span class="string">&quot;env-value&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /usr/<span class="built_in">local</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">443</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/usr/local/bin/my-program&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h4 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a><code>COPY</code></h4><p>复制指令，从上下文目录中复制文件或者目录到容器里指定路径。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="bash"> hom* /mydir/ COPY hom?.txt /mydir/</span></span><br></pre></td></tr></table></figure>
<p>ADD 指令和 COPY 的使用格类似（同样需求下，官方推荐使用 COPY）。功能也类似，不同之处如下：</p>
<ul>
<li>ADD 的优点：在执行 &lt;源文件&gt; 为 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，会自动复制并解压到 &lt;目标路径&gt;。</li>
<li>ADD 的缺点：在不解压的前提下，无法复制 tar 压缩文件。会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。具体是否使用，可以根据是否需要自动解压来决定。</li>
</ul>
<h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a><code>CMD</code></h4><p>类似于 RUN 指令，用于运行程序，但二者运行的时间点不同:</p>
<ul>
<li>  CMD 在docker run 时运行</li>
<li>  RUN 是在 docker build</li>
</ul>
<p><strong>作用</strong>：为启动的容器指定默认要运行的程序，程序运行结束，容器也就结束。CMD 指令指定的程序可被 docker run 命令行参数中指定要运行的程序所覆盖。</p>
<p><strong>注意</strong>：如果 Dockerfile 中如果存在多个 CMD 指令，仅最后一个生效。</p>
<h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a><code>ENV</code></h4><p>设置环境变量，定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。</p>
<p>格式：</p>
<p><code>ENV &lt;key&gt; &lt;value&gt; ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt;...</code></p>
<h4 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a><code>ARG</code></h4><p>构建参数，与 ENV 作用一致。不过作用域不一样。ARG 设置的环境变量仅对 Dockerfile 内有效。</p>
<h3 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a><code>docker-compose</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f file.yaml up -d</span><br><span class="line">docker-compose -f file.yaml up service_name -d</span><br><span class="line">docker-compose -f file.yaml image</span><br><span class="line">docker-compose -f file.yaml down</span><br><span class="line">docker-compose -f file.yaml [start, stop, restart] service_name</span><br><span class="line">docker-compose -f file.yaml config |less</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove deleted service</span></span><br><span class="line">docker-compose -f file.yaml up -d --remove-orphans</span><br></pre></td></tr></table></figure>
<p>Dockfile Example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">version</span> <span class="number">3.7</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">net-test:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">net-test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">haproxy:</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">haproxy:latest</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      /usr/local/bin/haproxy</span></span><br><span class="line"><span class="string">      --set-args-1:value-1</span></span><br><span class="line"><span class="string">      --set-args-2:value-2</span></span><br><span class="line"><span class="string">      --gprc:http://service_a:3366</span></span><br><span class="line"><span class="string"></span>    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10.0.0.1:1122:1122&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10.0.0.1:1133:1133&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">volmes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config:/usr/local/haproxy/config</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">service_a</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">service_b</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">service_a:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">service_b:</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>

<h3 id="Network-Alias"><a href="#Network-Alias" class="headerlink" title="Network Alias"></a>Network Alias</h3><p>虚拟多个IP地址，将container内的端口绑到独立的IP上，以更真实的方式模拟发布环境。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> up</span></span><br><span class="line">ifconfig en0 alias 10.0.0.10 netmask 0xFFFFFFFF up</span><br><span class="line">ifconfig en0 alias 10.0.0.11 netmask 0xFFFFFFFF up</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> down</span></span><br><span class="line">ifconfig en0 10.0.0.10 delete</span><br><span class="line">ifconfig en0 10.0.0.11 delete</span><br></pre></td></tr></table></figure>

<span id="more"></span></div></article></div></main><footer><div class="paginator"><a href="/2022/04/28/Git/" class="prev">上一篇</a><a href="/2022/04/27/GolangMore/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2022 <a href="http://yoursite.com">Simon Ren</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>