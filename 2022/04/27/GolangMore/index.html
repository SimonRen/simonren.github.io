<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Golang Tips More · Notebook</title><meta name="description" content="Golang Tips More - Simon Ren"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Notebook"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Notebook" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Golang Tips More</h1><div class="post-info">Apr 27, 2022</div><div class="post-content"><h3 id="embed"><a href="#embed" class="headerlink" title="embed"></a><code>embed</code></h3><p>GoDoc (<a target="_blank" rel="noopener" href="https://pkg.go.dev/embed">https://pkg.go.dev/embed</a>)</p>
<p>Package embed provides access to files embedded in the running Go program.</p>
<p>Go source files that import “embed” can use the //go:embed directive to initialize a variable of type string, []byte, or FS with the contents of files read from the package directory or subdirectories at compile time.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;embed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed hello.txt</span></span><br><span class="line"><span class="keyword">var</span> s <span class="keyword">string</span></span><br><span class="line"><span class="built_in">print</span>(s)</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;embed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed hello.txt</span></span><br><span class="line"><span class="keyword">var</span> b []<span class="keyword">byte</span></span><br><span class="line"><span class="built_in">print</span>(<span class="keyword">string</span>(b))</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;embed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed hello.txt</span></span><br><span class="line"><span class="keyword">var</span> f embed.FS</span><br><span class="line">data, _ := f.ReadFile(<span class="string">&quot;hello.txt&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="keyword">string</span>(data))</span><br></pre></td></tr></table></figure>
<ul>
<li>embeded files must under current folder. any file outside current folder will fail, for example <code>/root/somefile</code> will not work.</li>
<li><code>&quot;go:embed image/*&quot;</code> embeds all files under <code>image/</code>, including all file start with <code>.dot</code> and <code>_underscore</code>. </li>
<li><code>*</code> will not recursive sub folders. so <code>.dotfile</code> and <code>_underscore</code> will not be embeded with <code>image/subfolder/</code> sub folder.</li>
<li><code>&quot;go:embed image/&quot;</code> or <code>&quot;go:embed image&quot;</code> embeds all file but ignored which start with <code>.dot</code> and <code>_underscore</code>.</li>
<li>symbolic links are not followed.<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// embed multi files into a single filesystem</span></span><br><span class="line"><span class="comment">//go:embed image/* template/*</span></span><br><span class="line"><span class="comment">//go:embed html/index.html</span></span><br><span class="line"><span class="keyword">var</span> content embed.FS</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed image template html/index.html</span></span><br><span class="line"><span class="keyword">var</span> content embed.FS</span><br><span class="line"></span><br><span class="line"><span class="comment">// embed files with space</span></span><br><span class="line"><span class="comment">//go:embed &quot;he llo.txt&quot;</span></span><br><span class="line"><span class="keyword">var</span> content embed.FS</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Example with http-fileserver:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;embed&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed internal/embedtest/testdata/*.txt</span></span><br><span class="line"><span class="keyword">var</span> content embed.FS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mutex := http.NewServeMux()</span><br><span class="line">	mutex.Handle(<span class="string">&quot;/&quot;</span>, http.FileServer(http.FS(content)))</span><br><span class="line">	err := http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, mutex)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>embed filesystem need to access with full path from where embed declare, as follow:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:embed pg/migration/init.sql</span></span><br><span class="line"><span class="keyword">var</span> PgMigrationFs embed.FS</span><br></pre></td></tr></table></figure>
<p>you should access <code>init.sql</code> with full-path as <code>pg/migration/init.sql</code>.</p>
<h3 id="vendor"><a href="#vendor" class="headerlink" title="vendor"></a><code>vendor</code></h3><p><code>vendor</code>可以为docker image编译提供更快的速度，在测试时可以使用<code>vendor</code>模式来编译docker image。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: build-with-vendor</span></span><br><span class="line"><span class="section">build-with-vendor:</span></span><br><span class="line">	@if test -d <span class="string">&quot;./vendor/&quot;</span>; then echo <span class="string">&quot;checking vendor folder... [OK]&quot;</span>; <span class="keyword">else</span> echo <span class="string">&quot;checking vendor folder... [FAILED]&quot;</span>; echo <span class="string">&quot;run go mod vendor first&quot;</span>; exit 2; fi;</span><br><span class="line">	@echo <span class="string">&quot;start building with vendor...&quot;</span></span><br><span class="line">	go build -mod vendor -o bin/execute</span><br><span class="line">	@echo <span class="string">&quot;building done&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: build-image-with-vendor</span></span><br><span class="line"><span class="section">build-image-with-vendor:</span></span><br><span class="line">	@if test -d <span class="string">&quot;./vendor/&quot;</span>; then echo <span class="string">&quot;checking vendor folder... [OK]&quot;</span>; <span class="keyword">else</span> echo <span class="string">&quot;checking vendor folder... [FAILED]&quot;</span>; echo <span class="string">&quot;run go mod vendor first&quot;</span>; exit 2; fi;</span><br><span class="line">	@echo <span class="string">&quot;start building docker image with vendor...&quot;</span></span><br><span class="line">	@docker build -t local/project -f ./vendor.Dockerfile .</span><br><span class="line">	@echo <span class="string">&quot;building done&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="fmt-amp-lint"><a href="#fmt-amp-lint" class="headerlink" title="fmt &amp; lint"></a><code>fmt</code> &amp; <code>lint</code></h3><p>goimports: <a target="_blank" rel="noopener" href="https://pkg.go.dev/golang.org/x/tools/cmd/goimports">https://pkg.go.dev/golang.org/x/tools/cmd/goimports</a><br>golangci-lint: <a target="_blank" rel="noopener" href="https://github.com/golangci/golangci-lint">https://github.com/golangci/golangci-lint</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">goimports -d $(grep --files-without-match &#x27;DO NOT EDIT&#x27; $(find . -type f -name &#x27;*.go&#x27; -not -path &quot;./vendor/*&quot;))</span><br><span class="line">golangci-lint run --go=1.18 -D errcheck -D gosimple -D govet -j 8 -v ./...</span><br></pre></td></tr></table></figure>

<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a><code>Makefile</code></h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">COMMIT_SHA := <span class="variable">$(<span class="built_in">shell</span> git describe --all --first-parent --abbrev=8 --long --dirty --always)</span></span><br><span class="line">TIMESTAMP := <span class="variable">$(<span class="built_in">shell</span> date &#x27;+%Y-%m-%d_%H:%M:%S&#x27;)</span></span><br><span class="line">APP_LDFLAGS := <span class="string">&quot;-X &#x27;github.com/myproject/common.CommitSha=<span class="variable">$(COMMIT_SHA)</span>&#x27; -X &#x27;github.com/myproject/common.BuildTime=<span class="variable">$(TIMESTAMP)</span>&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Mock"><a href="#Mock" class="headerlink" title="Mock"></a>Mock</h3><p>Mock should be generated with <code>interface</code>, always implement side-effect logic with <code>interface</code>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mock while file</span></span><br><span class="line"><span class="comment">//go:generate mockgen -source=$GOFILE -destination=path/to/source/root/mocks/mock_$GOFILE -package=mocks</span></span><br><span class="line"><span class="keyword">type</span> ILogic <span class="keyword">interface</span> &#123;</span><br><span class="line">    Foo() <span class="keyword">string</span></span><br><span class="line">    Bar() <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mock specify interface</span></span><br><span class="line"><span class="comment">//go:generate mockgen -destination=./mock_ILogic.go -package=packageName github.com/myuser/myproject/path/to/package/ ILogic</span></span><br><span class="line"><span class="keyword">type</span> ILogic <span class="keyword">interface</span> &#123;</span><br><span class="line">    Foo() <span class="keyword">string</span></span><br><span class="line">    Bar() <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go generate ./...</span><br><span class="line">mockgen -source path/to/interface.go -destination path/to/mocks/mock_interface.go -package packageName</span><br></pre></td></tr></table></figure>

<h3 id="Unit-Test"><a href="#Unit-Test" class="headerlink" title="Unit Test"></a>Unit Test</h3></div></article></div></main><footer><div class="paginator"><a href="/2022/04/21/Golang/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2022 <a href="http://yoursite.com">Simon Ren</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>